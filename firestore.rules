rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // Note: Custom Claims를 사용하는 경우 request.auth.token.admin == true로 변경
    // 현재는 이메일 기반 체크를 사용하므로, 실제 admin 이메일 목록을 여기에 추가해야 함
    // .env.local과 Vercel 환경 변수의 NEXT_PUBLIC_ADMIN_EMAILS와 동일하게 유지해야 함
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.admin == true || 
              request.auth.token.email in [
                'catem86@gmail.com','catem8686@gmail.com',
                // 여기에 추가 관리자 이메일을 추가하세요
                // 예: 'admin2@example.com',
                // 예: 'admin3@example.com',
              ]); // 관리자 이메일 목록
    }
    
    // Helper function to check if user is the author
    function isAuthor(authorId) {
      return isAuthenticated() && request.auth.uid == authorId;
    }
    
    // ==================== 공지사항 (notices) ====================
    match /notices/{noticeId} {
      // 읽기: 모든 인증 사용자
      allow read: if isAuthenticated();
      
      // 생성: admin만
      allow create: if isAdmin();
      
      // 수정: admin만
      allow update: if isAdmin();
      
      // 삭제: admin만
      allow delete: if isAdmin();
    }
    
    // ==================== 피드백 (feedbacks) ====================
    match /feedbacks/{feedbackId} {
      // 읽기: 모든 인증 사용자
      allow read: if isAuthenticated();
      
      // 생성: 모든 인증 사용자
      allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid;
      
      // 수정: 작성자 또는 admin
      allow update: if isAuthenticated() && 
                       (isAuthor(resource.data.authorId) || isAdmin());
      
      // 삭제: 작성자 또는 admin
      allow delete: if isAuthenticated() && 
                       (isAuthor(resource.data.authorId) || isAdmin());
    }
    
    // ==================== 댓글 (comments) ====================
    match /comments/{commentId} {
      // 읽기: 모든 인증 사용자
      allow read: if isAuthenticated();
      
      // 생성: 모든 인증 사용자
      allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid;
      
      // 수정: 작성자만
      allow update: if isAuthenticated() && 
                       isAuthor(resource.data.authorId);
      
      // 삭제: 작성자만
      allow delete: if isAuthenticated() && 
                       isAuthor(resource.data.authorId);
    }
    
    // ==================== 사용자 데이터 (users) ====================
    match /users/{userId} {
      // 사용자 문서 자체 (프로필 정보 저장)
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // 사용자 프로필 (서브컬렉션 - 현재 사용하지 않지만 호환성을 위해 유지)
      match /userProfiles/{profileId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // 학급 명단
      match /classRosters/{rosterId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // 자리표
      match /layouts/{layoutId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // ==================== Storage 이미지 경로 (참고용) ====================
    // Storage 보안 규칙은 Firebase Console > Storage > Rules에서 별도로 설정해야 함
    // 예시:
    // rules_version = '2';
    // service firebase.storage {
    //   match /b/{bucket}/o {
    //     match /board/images/{userId}/{allPaths=**} {
    //       allow read: if request.auth != null;
    //       allow write: if request.auth != null && request.auth.uid == userId;
    //       allow delete: if request.auth != null && request.auth.uid == userId;
    //     }
    //   }
    // }
  }
}

